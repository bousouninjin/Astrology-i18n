---
import type { Lang } from '@/utils/i18n';
import { t } from '@/utils/translations';
import LanguageSwitcher from '@/features/LanguageSwitcher.astro';
import ThemeSwitcher from '@/features/ThemeSwitcher.astro';
import MainNav from '@/ui/MainNav.astro';
import MobileNav from '@/ui/MobileNav.astro';
import { Icon } from 'astro-icon/components';
import { getRelativeLocaleUrl } from 'astro:i18n';

const resolvedLang = ((Astro.currentLocale as Lang | undefined) ??
  (Astro.props.lang as Lang | undefined) ??
  'zh') as Lang;

const siteName = t(resolvedLang, 'site.name');
---

<header class="relative z-50 border-b border-base-300">
  <div class="navbar container">
    <div class="navbar-start gap-2 lg:w-1/2">
      <button
        type="button"
        class="btn btn-ghost btn-circle lg:hidden"
        aria-label="Menu"
        data-mobile-trigger
      >
        <Icon name="lucide:menu" />
      </button>
      <a href={getRelativeLocaleUrl(resolvedLang, '/')} class="text-xl font-semibold lg:hidden">
        {siteName}
      </a>
    </div>

    <div class="navbar-center hidden lg:flex">
      <a href={getRelativeLocaleUrl(resolvedLang, '/')} class="text-xl font-semibold">
        {siteName}
      </a>
    </div>

    <div class="navbar-end gap-1">
      <ThemeSwitcher lang={resolvedLang} />
      <a
        href={getRelativeLocaleUrl(resolvedLang, '/search')}
        aria-label="Search"
        title={t(resolvedLang, 'search.title')}
        class="btn btn-ghost btn-circle"
      >
        <Icon name="lucide:search" />
      </a>
      <LanguageSwitcher lang={resolvedLang} />
    </div>
  </div>

  <div class="hidden border-t border-base-300 lg:block">
    <div class="container">
      <MainNav lang={resolvedLang} />
    </div>
  </div>

  <MobileNav lang={resolvedLang} />
</header>

<script>
  import { registerPageInit } from '@/utils/page-init';

  function handleMobileToggle() {
    const panel = document.querySelector('[data-mobile-panel]');
    if (panel) panel.classList.toggle('hidden');
  }

  function initMobileMenu() {
    const btn = document.querySelector('[data-mobile-trigger]');
    if (!btn) return;

    btn.removeEventListener('click', handleMobileToggle);
    btn.addEventListener('click', handleMobileToggle);

    return () => {
      btn.removeEventListener('click', handleMobileToggle);
    };
  }

  registerPageInit('mobileMenu', initMobileMenu);
</script>
