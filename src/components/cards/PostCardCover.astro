---
import OptimizedPicture from '@/features/OptimizedPicture.astro';
import SkeletonCardCover from '@/ui/SkeletonCardCover.astro';
import Divider from '@/ui/Divider.astro';
import { formatDate } from '@/utils/date';
import type { Lang } from '@/utils/i18n';
import { categoryLabel, tagLabel } from '@/utils/translations';

interface Props {
  href?: string;
  imageSrc: any;
  imageAlt: string;
  title: string;
  description?: string;
  date?: string | Date;
  tags?: string[];
  lang?: Lang;

  priority?: boolean;
  aspectClass?: string;
  variant?: 'default' | 'news';
  class?: string;
  loading?: boolean;
}

const {
  href,
  imageSrc,
  imageAlt,
  title,
  description,
  date,
  tags = [],
  lang = 'zh',
  priority = false,
  aspectClass = 'aspect-video',
  variant = 'default',
  class: className,
  loading = false,
} = Astro.props as Props;

const Container = href ? 'a' : 'div';
const containerAttrs = href ? { href } : {};
const isNews = variant === 'news';
const containerClass = [
  'group relative isolate flex h-full flex-col gap-2',
  isNews ? 'max-w-sm mx-auto' : '',
  className ?? '',
]
  .filter(Boolean)
  .join(' ');
const titleClass = isNews
  ? 'text-[15px] font-sans font-normal leading-[1.15] lg:group-hover:underline underline-offset-2'
  : 'text-[15px] font-sans font-normal leading-[1.15] lg:group-hover:underline underline-offset-2';
const descriptionClass = 'text-sm text-base-content/80 text-pretty lg:mb-auto';
const metaClass = isNews ? 'mt-2' : 'mt-auto';
---

{
  loading ? (
    <SkeletonCardCover aspectClass={aspectClass} class={className} />
  ) : (
    <Container
      {...containerAttrs}
      class={containerClass}
    >
      <div class={`overflow-hidden rounded-md ${aspectClass}`}>
        <OptimizedPicture
          src={imageSrc}
          alt={imageAlt}
          class="h-full w-full object-cover transition-transform duration-300 ease-out group-hover:scale-[1.02]"
          fit="cover"
          position="center"
          priority={priority}
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 400px"
        />
      </div>
      <div class="flex flex-1 flex-col gap-2">
        <h3
          class={titleClass}
          style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;"
        >
          {title}
        </h3>
        {isNews && description && (
          <p
            class={descriptionClass}
            style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;"
          >
            {description}
          </p>
        )}
        <div class={`${metaClass} flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-base-content/80`.trim()}>
          {tags?.map((tag) => <span class="text-primary dark:text-secondary">#{tagLabel(lang, tag)}</span>)}
          {tags?.length > 0 && date && <Divider />}
          <span>{date ? formatDate(date, lang) : ''}</span>
        </div>
      </div>
    </Container>
  )
}
