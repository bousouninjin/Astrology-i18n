---
import OptimizedPicture from '@/features/OptimizedPicture.astro';
import SkeletonCardDescription from '@/ui/SkeletonCardDescription.astro';
import Divider from '@/ui/Divider.astro';
import { formatDate } from '@/utils/date';
import type { Lang } from '@/utils/i18n';
import { categoryLabel, tagLabel } from '@/utils/translations';

interface Props {
  href?: string;
  imageSrc: any;
  imageAlt: string;
  title: string;
  description?: string;
  date?: string | Date;
  tags?: string[];
  lang?: Lang;

  priority?: boolean;
  aspectClass?: string;
  variant?: 'default' | 'subheadline';
  class?: string;
  loading?: boolean;
}

const {
  href,
  imageSrc,
  imageAlt,
  title,
  description,
  date,
  tags = [],
  lang = 'zh',
  priority = false,
  aspectClass = 'aspect-video',
  variant = 'default',
  class: className,
  loading = false,
} = Astro.props as Props;

const Container = href ? 'a' : 'div';
const containerAttrs = href ? { href } : {};
const isSubheadline = variant === 'subheadline';
const containerClass = [
  'group relative isolate flex',
  isSubheadline ? 'items-stretch gap-2' : 'flex-col gap-3 sm:flex-row',
  className ?? '',
]
  .filter(Boolean)
  .join(' ');
const contentClass = isSubheadline
  ? 'flex flex-1 flex-col gap-2'
  : 'flex flex-1 flex-col gap-2 py-1';
const metaClass = isSubheadline ? 'mt-1 lg:mt-auto' : 'mt-auto';
const imageWrapperClass = isSubheadline
  ? 'overflow-hidden w-[165px] h-[125px] md:w-[120px] md:h-full shrink-0 rounded-md'
  : `overflow-hidden rounded-md ${aspectClass} w-full sm:w-40 shrink-0`;
const sizesAttr = isSubheadline ? '(max-width: 768px) 165px, 120px' : '(max-width: 640px) 100vw, 160px';
---

{
  loading ? (
    <SkeletonCardDescription aspectClass={aspectClass} variant={variant} class={className} />
  ) : (
    <Container
      {...containerAttrs}
      class={containerClass}
    >
      <div class={contentClass}>
        <h3
          class="text-[15px] font-sans font-normal leading-[1.15] lg:group-hover:underline underline-offset-2"
          style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;"
        >
          {title}
        </h3>
        {description && (
          <p
            class="text-sm text-base-content/80"
            style="display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden;"
          >
            {description}
          </p>
        )}
        <div class={`${metaClass} flex flex-wrap items-center gap-x-2 gap-y-1 text-xs text-base-content/80`.trim()}>
          {tags?.map((tag) => <span class="text-primary dark:text-secondary">#{tagLabel(lang, tag)}</span>)}
          {tags?.length > 0 && date && <Divider />}
          <span>{date ? formatDate(date, lang) : ''}</span>
        </div>
      </div>
      <div class={imageWrapperClass}>
        <OptimizedPicture
          src={imageSrc}
          alt={imageAlt}
          class="h-full w-full object-cover transition-transform duration-300 ease-out group-hover:scale-[1.02]"
          fit="cover"
          position="center"
          priority={priority}
          sizes={sizesAttr}
        />
      </div>
    </Container>
  )
}
