---
interface PageMeta {
  data: any[];
  start: number;
  end: number;
  total: number;
  currentPage: number;
  size: number;
  lastPage: number;
  url: {
    current: string;
    prev?: string | null | undefined;
    next?: string | null | undefined;
    first?: string | null | undefined;
    last?: string | null | undefined;
  };
}

interface Props {
  page: PageMeta;
  window?: number;
  class?: string;
}

const { page, window: win = 2, class: className } = Astro.props as Props;

function hrefFor(n: number): string {
  const cur = page.url.current;
  const base = cur.replace(/\/(\d+)(\/)$/, '/');
  if (n <= 1) return base;

  return `${base.replace(/\/?$/, '/')}${n}/`;
}

function uniq<T>(arr: T[]): T[] {
  return [...new Set(arr)];
}

function computePages(curr: number, last: number, win: number): Array<number | '…'> {
  const pages: Array<number | '…'> = [];
  const start = Math.max(1, curr - win);
  const end = Math.min(last, curr + win);
  const base = [1, ...Array.from({ length: end - start + 1 }, (_, i) => start + i), last];
  const sorted = uniq(base).sort((a, b) => Number(a) - Number(b));
  for (let i = 0; i < sorted.length; i++) {
    const n = sorted[i]!;
    pages.push(n as number);
    const next = sorted[i + 1];
    if (next !== undefined && next - n > 1) pages.push('…');
  }
  return pages;
}

const items = computePages(page.currentPage, page.lastPage, win);
---

{
  page.lastPage > 1 && (
    <>
      <nav
        aria-label="Pagination"
        class={`mt-8 flex items-center justify-center sm:hidden ${className ?? ''}`.trim()}
      >
        <div class="join">
          {page.url.prev ? (
            <a href={page.url.prev} class="join-item btn btn-sm" aria-label="Previous">
              ‹
            </a>
          ) : (
            <span class="join-item btn btn-sm btn-disabled">‹</span>
          )}
          <span class="join-item btn btn-sm btn-disabled">
            {page.currentPage} / {page.lastPage}
          </span>
          {page.url.next ? (
            <a href={page.url.next} class="join-item btn btn-sm" aria-label="Next">
              ›
            </a>
          ) : (
            <span class="join-item btn btn-sm btn-disabled">›</span>
          )}
        </div>
      </nav>

      <nav
        aria-label="Pagination"
        class={`mt-8 hidden items-center justify-center sm:flex ${className ?? ''}`.trim()}
      >
        <div class="join">
          {page.url.first ? (
            <a href={page.url.first} class="join-item btn btn-sm">
              «
            </a>
          ) : (
            <span class="join-item btn btn-sm btn-disabled">«</span>
          )}

          {page.url.prev ? (
            <a href={page.url.prev} class="join-item btn btn-sm">
              ‹
            </a>
          ) : (
            <span class="join-item btn btn-sm btn-disabled">‹</span>
          )}

          {items.map((it) =>
            it === '…' ? (
              <span class="join-item btn btn-sm btn-disabled">…</span>
            ) : it === page.currentPage ? (
              <span class="join-item btn btn-sm btn-active pointer-events-none">{it}</span>
            ) : (
              <a href={hrefFor(it as number)} class="join-item btn btn-sm">
                {it}
              </a>
            ),
          )}

          {page.url.next ? (
            <a href={page.url.next} class="join-item btn btn-sm">
              ›
            </a>
          ) : (
            <span class="join-item btn btn-sm btn-disabled">›</span>
          )}

          {page.url.last ? (
            <a href={page.url.last} class="join-item btn btn-sm">
              »
            </a>
          ) : (
            <span class="join-item btn btn-sm btn-disabled">»</span>
          )}
        </div>
      </nav>
    </>
  )
}
