---
import MainLayout from '@/layouts/MainLayout.astro';
import BaseHeader from '@/ui/BaseHeader.astro';
import Prose from '@/features/Prose.astro';
import OptimizedPicture from '@/features/OptimizedPicture.astro';
import Share from '@/features/Share.astro';
import { Image } from 'astro:assets';
import authorAvatar from '@/assets/author.avif';
import type { Lang } from '@/utils/i18n';
import { t, categoryLabel as i18nCategoryLabel, categorySlug, tagLabel } from '@/utils/translations';
import { formatDate } from '@/utils/date';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { Icon } from 'astro-icon/components';

interface Props {
  lang?: Lang;
  title: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  canonical?: string;
  noindex?: boolean;
  publishedTime?: string | Date | undefined;
  modifiedTime?: string | Date | undefined;
  author?: string;
  authorUrl?: string;
  section?: string;
  tags?: string[];
  noProse?: boolean;
}

const {
  lang: langProp = 'zh',
  title,
  description,
  image,
  imageAlt,
  canonical,
  noindex,
  publishedTime,
  modifiedTime,
  author,
  authorUrl,
  section,
  tags = [],
} = Astro.props as Props;
const resolvedLang = ((Astro.currentLocale as Lang | undefined) ??
  (langProp as Lang | undefined) ??
  'zh') as Lang;

const fmt = (d?: string | Date) => formatDate(d, resolvedLang);
const showModified =
  !!modifiedTime && String(modifiedTime) !== String(publishedTime ?? '');

const categoryLabel = i18nCategoryLabel(resolvedLang, section);
const categoryKey = categorySlug(resolvedLang, section);
const headerProps = {
  lang: resolvedLang,
  title,
  ...(description ? { description } : {}),
  ...(image ? { image } : {}),
  ...(imageAlt ? { imageAlt } : {}),
  ...(publishedTime ? { publishedTime } : {}),
  ...(modifiedTime ? { modifiedTime } : {}),
  ...(canonical ? { canonical } : {}),
  ...(typeof noindex === 'boolean' ? { noindex } : {}),
  ...(author ? { authorName: author } : {}),
  ...(authorUrl ? { authorUrl } : {}),
  ...(section ? { section } : {}),
  ...(Array.isArray(tags) && tags.length ? { tags } : {}),
};
---

<MainLayout lang={resolvedLang}>
  <BaseHeader {...headerProps} slot="head" />
  <section class="mb-8 flex flex-col border-b border-base-300 pb-4 pt-0 lg:flex-col-reverse lg:border-none lg:pt-6">
    {
      image && (
        <div class="mx-auto w-full max-w-5xl overflow-hidden lg:rounded-md">
          <div class="aspect-[20/9] w-full overflow-hidden">
            <OptimizedPicture
              src={image}
              alt={imageAlt || title}
              priority
              layout="full-width"
              fit="cover"
              position="center"
              rounded={false}
              class="h-full w-full object-cover"
              sizes="(max-width: 1024px) 100vw, 1024px"
            />
          </div>
        </div>
      )
    }
    {tags && tags.length > 0 && (
      <div class="mx-auto my-4 flex w-full max-w-5xl items-center gap-2 text-sm text-base-content/70 lg:hidden">
        <Icon name="lucide:tags" class="h-4 w-4 shrink-0" />
        <div class="flex flex-wrap gap-2">
          {tags.map((tag) => (
                    <span class="font-semibold text-primary dark:text-secondary">#{tagLabel(resolvedLang, tag)}</span>
          ))}
        </div>
      </div>
    )}
    <div class="mx-auto w-full max-w-5xl">
      <h1 class="text-left text-[26px] font-bold leading-[1.3] text-[#333] tracking-[-1.1px] dark:text-neutral-100 lg:text-[26px]">{title}</h1>
      <div class="mt-2 flex flex-col items-start gap-4 text-sm lg:mt-6">
        {(tags?.length > 0 || publishedTime) && (
          <div class="flex flex-wrap items-center gap-2 text-base-content/70">
            {tags && tags.length > 0 && (
              <span class="hidden items-center gap-2 lg:flex">
                <Icon name="lucide:tags" class="h-4 w-4 shrink-0" />
                <div class="flex flex-wrap gap-2">
                  {tags.map((tag) => (
                            <span class="font-semibold text-primary dark:text-secondary">#{tagLabel(resolvedLang, tag)}</span>
                  ))}
                </div>
              </span>
            )}
            {tags?.length > 0 && publishedTime && (
              <div class="divider divider-horizontal mx-2 h-4" aria-hidden="true" />
            )}
            {publishedTime && (
              <span class="flex items-center gap-1">
                <Icon name="lucide:calendar" class="h-4 w-4" />
                <time datetime={new Date(publishedTime).toISOString()}>
                  {fmt(publishedTime)}
                </time>
              </span>
            )}
          </div>
        )}
        <div class="flex w-full flex-wrap items-center justify-between gap-3">
          {author ? (
            <a
              href={getRelativeLocaleUrl(resolvedLang, '/author/')}
              class="flex items-center gap-2 text-sm text-neutral-600 no-underline transition-opacity hover:opacity-80 dark:text-neutral-300"
            >
              <Image src={authorAvatar} alt={author} width={32} height={32} class="rounded-full" />
              <span class="font-semibold">{author}</span>
            </a>
          ) : (
            <span />
          )}
          <Share lang={resolvedLang} title={title} />
        </div>
      </div>
    </div>
  </section>

  {
    Astro.props.noProse ? (
      <slot />
    ) : (
      <Prose class="prose-base !leading-[1.8] text-[16px] text-[#333] dark:text-neutral-200">
        <slot />
        {showModified && (
          <p class="mt-6 text-xs text-neutral-500 dark:text-neutral-400">
            {t(resolvedLang, 'post.modifiedAt')}: {fmt(modifiedTime)}
          </p>
        )}
      </Prose>
    )
  }
  <slot name="after" />
</MainLayout>
