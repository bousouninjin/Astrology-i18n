---
import fallbackAvatar from '@/assets/author.avif';
import OptimizedPicture from '@/features/OptimizedPicture.astro';
import LandingLayout from '@/layouts/LandingLayout.astro';
import type { Lang } from '@/utils/i18n';
import { DEFAULT_LANG, SUPPORTED_LANGS } from '@/utils/i18n';
import { t } from '@/utils/translations';
import { getRelativeLocaleUrl } from 'astro:i18n';
import { getCollection, type CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  return SUPPORTED_LANGS.map((lang) => ({ params: { lang } }));
}

const lang = ((Astro.params.lang as Lang) || DEFAULT_LANG) as Lang;
const authors = await getCollection('author', (a) => !a.data.draft && a.data.locales === (lang as any));
const pageTitle = t(lang, 'pages.author.title') || (lang === 'zh' ? '作者' : 'Author');
const description = t(lang, 'pages.author.description') || '';

type Author = CollectionEntry<'author'>;
const toAuthorUrl = (author: Author) => {
  const idWithoutExt = author.id.replace(/\.(md|mdx|markdown)$/i, '');
  const slug = idWithoutExt.replace(new RegExp(`^${lang}/`), '');
  return getRelativeLocaleUrl(lang, `/author/${slug}/`);
};
---

<LandingLayout
  lang={lang}
  title={pageTitle}
  description={description}
  canonical={Astro.url.href}
>
  <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">
    <section class="space-y-6">
      <div class="flex items-baseline justify-between">
        <h1 class="text-3xl font-bold tracking-tight sm:text-4xl">
          {pageTitle}
        </h1>
      </div>

      <ul class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {authors.map((author) => {
          const avatar = author.data.avatar || (fallbackAvatar as any);
          return (
            <li class="group rounded-2xl bg-white/80 p-6 shadow-md shadow-black/5 transition-all hover:shadow-lg dark:bg-neutral-900/80 dark:shadow-white/5">
              <a href={toAuthorUrl(author)} class="block">
                <div class="flex items-center gap-4">
                  <OptimizedPicture
                    src={avatar}
                    alt={author.data.name}
                    width={96}
                    height={96}
                    class="h-16 w-16 rounded-full object-cover ring-2 ring-neutral-200 group-hover:ring-neutral-300 dark:ring-neutral-700"
                    layout="fixed"
                    fit="cover"
                  />
                  <div class="min-w-0">
                    <h2 class="text-lg font-semibold group-hover:underline">
                      {author.data.name}
                    </h2>
                    {author.data.bio && (
                      <p class="mt-1 line-clamp-2 text-sm text-neutral-600 dark:text-neutral-400">
                        {author.data.bio}
                      </p>
                    )}
                  </div>
                </div>
              </a>
            </li>
          );
        })}
      </ul>
    </section>
  </div>
</LandingLayout>
