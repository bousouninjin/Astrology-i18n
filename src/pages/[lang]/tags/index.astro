---
import { getCollection } from 'astro:content';
import LandingLayout from '@/layouts/LandingLayout.astro';
import type { Lang } from '@/utils/i18n';
import { DEFAULT_LANG, SUPPORTED_LANGS } from '@/utils/i18n';
import { t } from '@/utils/translations';
import { NAV_ITEMS } from '@/utils/navItems';

export async function getStaticPaths() {
  return SUPPORTED_LANGS.map((lang) => ({ params: { lang } }));
}

const lang = ((Astro.params.lang as Lang) || DEFAULT_LANG) as Lang;

const all = await getCollection('post', (p) => !p.data.draft && p.data.locales === lang);

const TAG_KEYS = [...new Set(NAV_ITEMS.flatMap((item) => item.tags))];

function countFor(key: (typeof TAG_KEYS)[number]) {
  const translated = String(t(lang as any, `tags.${key}`)).toLowerCase();
  return all.filter((p) => {
    const tags = (p.data.tags || []).map((x: string) => String(x).toLowerCase());
    return tags.includes(translated) || tags.includes(String(key));
  }).length;
}

const items = TAG_KEYS.map((key) => ({
  key,
  label: String(t(lang as any, `tags.${key}`)),
  href: `/${lang}/tags/${key}/`,
  count: countFor(key),
}));

const pageTitle = t(lang, 'pages.tags.title');
const description = t(lang, 'pages.tags.description');
---

<LandingLayout
  lang={lang}
  title={pageTitle}
  description={description}
  canonical={Astro.url.href}
  centered={false}
>
  <section>
    <h2 class="mb-4 text-lg font-semibold">{t(lang, 'pages.tags.h2')}</h2>
    <div class="grid grid-cols-2 gap-3 sm:grid-cols-3">
      {
        items.map((it) => (
          <a
            href={it.href}
            class="btn btn-outline btn-sm w-full justify-between"
          >
            <span class="min-w-0 flex-1 truncate">{it.label}</span>
            <span class="badge badge-neutral badge-sm">
              {it.count}
            </span>
          </a>
        ))
      }
    </div>
  </section>
</LandingLayout>
