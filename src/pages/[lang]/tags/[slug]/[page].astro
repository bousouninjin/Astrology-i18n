---
import { getCollection, type CollectionEntry } from 'astro:content';
import LandingLayout from '@/layouts/LandingLayout.astro';
import Pagination from '@/features/Pagination.astro';
import CategoryListItem from '@/cards/CategoryListItem.astro';
import type { Lang } from '@/utils/i18n';
import { DEFAULT_LANG, SUPPORTED_LANGS } from '@/utils/i18n';
import { t, tagLabel } from '@/utils/translations';
import { NAV_ITEMS } from '@/utils/navItems';

import type { GetStaticPaths } from 'astro';

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
  const posts = await getCollection('post', (p) => !p.data.draft);
  const TAG_KEYS = [...new Set(NAV_ITEMS.flatMap((item) => item.tags))];

  const byLangAndTag = SUPPORTED_LANGS.flatMap((lang) => {
    const listForLang = posts
      .filter((p) => p.data.locales === (lang as any))
      .sort((a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime());

    return TAG_KEYS.flatMap((key) => {
      const translated = String(t(lang as any, `tags.${key}`)).toLowerCase();
      const list = listForLang.filter((p) => {
        const tags = (p.data.tags || []).map((x: string) => String(x).toLowerCase());
        return tags.includes(translated) || tags.includes(String(key));
      });
      return paginate(list, { pageSize: 12, params: { lang, slug: key } });
    });
  });

  return byLangAndTag;
};

type Post = CollectionEntry<'post'>;

function toUrl(entry: Post, lang: Lang): string {
  const idWithoutExt = entry.id.replace(/\.(md|mdx|markdown)$/i, '');
  const slug = idWithoutExt.replace(new RegExp(`^${lang}/`), '');
  return `/${lang}/posts/${slug}/`;
}

const lang = ((Astro.params.lang as Lang) || DEFAULT_LANG) as Lang;
const slug = String(Astro.params.slug || '');
const pageParam = Astro.params.page as string | undefined;
if (pageParam === '1') {
  return Astro.redirect(`/${lang}/tags/${slug}/`, 301);
}

const { page } = Astro.props as { page: any };
const items = (page?.data as Post[]) || [];

const h1Key = `headings.${slug}.h1`;
const h1Trans = t(lang, h1Key);
const h1 = h1Trans !== h1Key ? h1Trans : (tagLabel(lang, slug) || slug);

const h2Key = `headings.${slug}.h2`;
const h2Trans = t(lang, h2Key);
const h2 = h2Trans !== h2Key ? h2Trans : '';
const title = h1;
const description = h2 || t(lang, 'pages.tags.description');
const heading = tagLabel(lang, slug) || h1 || slug;
---

<LandingLayout
  lang={lang}
  title={title}
  description={description}
  canonical={Astro.url.href}
  showHeader={false}
  mainClass="flex flex-col h-full pb-8 pt-4"
>
  <div class="flex flex-col h-full" data-pagefind-ignore="all">
    <section class="flex items-center border-b-2 border-primary/10 p-1 mb-4">
      <h1 class="text-xl font-bold capitalize">{heading}</h1>
    </section>
    <ul class="flex flex-col gap-2 flex-1">
      {
        items.map((p, idx) => (
          <CategoryListItem
            href={toUrl(p, lang)}
            imageSrc={p.data.heroImage}
            imageAlt={p.data.heroImageAlt}
            title={p.data.title}
            description={p.data.description}
            date={p.data.pubDate}
            category={p.data.category}
            lang={lang}
            priority={idx === 0}
            isLast={idx === items.length - 1}
          />
        ))
      }
    </ul>
    <Pagination page={page} class="mt-8" />
  </div>
</LandingLayout>
