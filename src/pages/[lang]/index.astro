---
import { getCollection, type CollectionEntry } from 'astro:content';
import LandingLayout from '@/layouts/LandingLayout.astro';
import PostCardCover from '@/cards/PostCardCover.astro';
import PostCardDescription from '@/cards/PostCardDescription.astro';
import PostCardHorizontal from '@/cards/PostCardHorizontal.astro';
import PostCardText from '@/cards/PostCardText.astro';
import Pagination from '@/features/Pagination.astro';
import CardWithPriority from '@/features/CardWithPriority.astro';
import OptimizedPicture from '@/features/OptimizedPicture.astro';
import fallbackAvatar from '@/assets/author.avif';
import type { Lang } from '@/utils/i18n';
import { DEFAULT_LANG, SUPPORTED_LANGS } from '@/utils/i18n';
import { t } from '@/utils/translations';
import { getRelativeLocaleUrl } from 'astro:i18n';

export async function getStaticPaths() {
  return SUPPORTED_LANGS.map((lang) => ({ params: { lang } }));
}

type Post = CollectionEntry<'post'>;
type Author = CollectionEntry<'author'>;

function toUrl(entry: Post, lang: Lang): string {
  const idWithoutExt = entry.id.replace(/\.(md|mdx|markdown)$/i, '');
  const slug = idWithoutExt.replace(new RegExp(`^${lang}/`), '');
  return `/${lang}/posts/${slug}/`;
}

const PAGE_SIZE = 12;
const lang = ((Astro.params.lang as Lang) || DEFAULT_LANG) as Lang;

const posts = await getCollection('post', (p) => !p.data.draft && p.data.locales === (lang as any));
const all = posts.sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime(),
);
const items = all.slice(0, PAGE_SIZE);

const mainHeadline = items[0];
const subHeadlines = items.slice(1, 5);
const latestItems = items.slice(5, 11);
const moreItems = items.slice(11);

const authors = await getCollection('author', (a) => !a.data.draft && a.data.locales === (lang as any));
const authorItems = authors.slice(0, 6) as Author[];

const total = all.length;
const lastPage = Math.max(1, Math.ceil(total / PAGE_SIZE));
const page = {
  data: items,
  start: 0,
  end: items.length - 1,
  total,
  currentPage: 1,
  size: PAGE_SIZE,
  lastPage,
  url: {
    current: Astro.url.pathname,
    prev: undefined,
    next: lastPage > 1 ? `/${lang}/2/` : undefined,
    first: undefined,
    last: lastPage > 1 ? `/${lang}/${lastPage}/` : undefined,
  },
};

const h1 = t(lang, 'headings.home.h1');
const h2 = t(lang, 'headings.home.h2');
const title = t(lang, 'headings.home.title') || h1;
const latestTitle = t(lang, 'homepage.latestArticles');
const latestLinkText = t(lang, 'common.readMore');
const authorTitle = t(lang, 'pages.author.title');
---

<LandingLayout
  lang={lang}
  title={title}
  canonical={Astro.url.href}
  showHeader={false}
  mainClass="pt-0 pb-6 lg:pb-8"
>
  <section class="grid grid-cols-1 gap-6 pt-4 md:grid-cols-10 md:pt-8" data-pagefind-ignore="all">
    <div class="sr-only">
      <h1>{h1}</h1>
      <h2>{h2}</h2>
      <p>{t(lang, 'site.description')}</p>
    </div>
    <div class="md:col-span-6">
      {
        mainHeadline && (
          <CardWithPriority
            component={PostCardHorizontal}
            index={0}
            props={{
              href: toUrl(mainHeadline, lang),
              imageSrc: mainHeadline.data.heroImage,
              imageAlt: mainHeadline.data.heroImageAlt,
              title: mainHeadline.data.title,
              description: mainHeadline.data.description,
              date: mainHeadline.data.pubDate,
              tags: mainHeadline.data.tags,
              lang,
              variant: 'headline',
            }}
          />
        )
      }
    </div>
    <div class="md:col-span-4">
      {
        subHeadlines.map((p, idx) => (
          <PostCardDescription
            href={toUrl(p, lang)}
            imageSrc={p.data.heroImage}
            imageAlt={p.data.heroImageAlt}
            title={p.data.title}
            description={p.data.description}
            date={p.data.pubDate}
            tags={p.data.tags}
            lang={lang}
            variant="subheadline"
            class={`py-2 ${idx === 0 ? 'pt-0' : ''} ${
              idx === subHeadlines.length - 1 ? 'pb-0' : 'border-b border-base-300'
            }`}
          />
        ))
      }
    </div>
  </section>

  <section class="pt-12 pb-0 space-y-4" data-pagefind-ignore="all">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-bold">{latestTitle}</h2>
      <a href={getRelativeLocaleUrl(lang, '/posts')} class="link link-hover text-sm">
        {latestLinkText}
      </a>
    </div>
    <div class="grid grid-cols-1 gap-4 gap-y-6 md:grid-cols-3 md:grid-rows-2">
      {
        latestItems.map((p, idx) => (
          <CardWithPriority
            component={PostCardCover}
            index={idx}
            props={{
              href: toUrl(p, lang),
              imageSrc: p.data.heroImage,
              imageAlt: p.data.heroImageAlt,
              title: p.data.title,
              description: p.data.description,
              date: p.data.pubDate,
              tags: p.data.tags,
              lang,
              variant: 'news',
            }}
          />
        ))
      }
    </div>
  </section>

  {
    moreItems.length > 0 && (
      <section class="pt-10">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">{t(lang, 'homepage.topArticles')}</h2>
        </div>
        <div class="mt-3 divide-y divide-base-300">
          {moreItems.map((p) => (
            <PostCardText
              href={toUrl(p, lang)}
              title={p.data.title}
              date={p.data.pubDate}

              tags={p.data.tags}
              lang={lang}
            />
          ))}
        </div>
      </section>
    )
  }

  {
    authorItems.length > 0 && (
      <section class="py-12" data-pagefind-ignore="all">
        <div class="flex items-center justify-between">
          <h2 class="text-xl font-bold">{authorTitle}</h2>
          <a href={getRelativeLocaleUrl(lang, '/author')} class="link link-hover text-sm">
            {latestLinkText}
          </a>
        </div>
        <ul
          role="list"
          class="mt-4 grid grid-cols-2 gap-x-4 gap-y-8 sm:grid-cols-3 lg:grid-cols-6 sm:gap-y-12"
        >
          {authorItems.map((author) => {
            const avatar = author.data.avatar || (fallbackAvatar as any);
            return (
              <li class="group relative isolate">
                <OptimizedPicture
                  src={avatar}
                  alt={author.data.name}
                  width={320}
                  height={320}
                  class="w-80 aspect-square max-w-full object-cover grayscale group-hover:grayscale-0 rounded-md"
                  layout="constrained"
                  fit="cover"
                />
                <div class="mt-2 flex flex-col gap-0.5">
                  <h3 class="text-base font-semibold group-hover:underline">
                    <a href={getRelativeLocaleUrl(lang, '/author')}>
                      <span class="absolute inset-0 z-10 pointer-events-none"></span>
                      {author.data.name}
                    </a>
                  </h3>
                  {author.data.bio && (
                    <p
                      class="text-sm text-primary dark:text-secondary"
                      style="display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;"
                    >
                      {author.data.bio}
                    </p>
                  )}
                </div>
              </li>
            );
          })}
        </ul>
      </section>
    )
  }

  <Pagination page={page} class="mt-10" />
</LandingLayout>
